<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Deploy Red Hat Quay for proof-of-concept (non-production) purposes</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.4"/><meta name="description" content="Get started with Red Hat Quay"/><link rel="next" href="#idm45346039465216" title="Preface"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm45346038722208"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Quay</span> <span class="productnumber">3.4</span></div><div><h1 class="title">Deploy Red Hat Quay for proof-of-concept (non-production) purposes</h1></div><div><h2 class="subtitle">Deploy Red Hat Quay</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat OpenShift Documentation Team</span></div></div><div><a href="#idm45346019194624">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				Get started with Red Hat Quay
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="preface"><a href="#idm45346039465216">Preface</a></span></li><li><span class="chapter"><a href="#overview">1. Overview</a></span><ul><li><span class="section"><a href="#architecture">1.1. Architecture</a></span><ul><li><span class="section"><a href="#internal_components">1.1.1. Internal components</a></span></li><li><span class="section"><a href="#external_components">1.1.2. External components</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#getting_started_with_red_hat_quay">2. Getting started with Red Hat Quay</a></span><ul><li><span class="section"><a href="#prerequisites">2.1. Prerequisites</a></span><ul><li><span class="section"><a href="#using_podman">2.1.1. Using podman</a></span></li></ul></li><li><span class="section"><a href="#configuring_the_rhel_server">2.2. Configuring the RHEL server</a></span><ul><li><span class="section"><a href="#install_and_register_red_hat_enterprise_linux_server">2.2.1. Install and register Red Hat Enterprise Linux server</a></span></li><li><span class="section"><a href="#installing_podman">2.2.2. Installing podman</a></span></li><li><span class="section"><a href="#registry_authentication">2.2.3. Registry authentication</a></span></li><li><span class="section"><a href="#firewall_configuration">2.2.4. Firewall configuration</a></span></li><li><span class="section"><a href="#ip-naming">2.2.5. IP addressing and naming services</a></span></li></ul></li><li><span class="section"><a href="#configuring_the_database">2.3. Configuring the database</a></span><ul><li><span class="section"><a href="#setting_up_postgres">2.3.1. Setting up Postgres</a></span></li></ul></li><li><span class="section"><a href="#configuring_redis">2.4. Configuring Redis</a></span><ul><li><span class="section"><a href="#setting_up_redis">2.4.1. Setting up Redis</a></span></li></ul></li><li><span class="section"><a href="#configuring_red_hat_quay">2.5. Configuring Red Hat Quay</a></span><ul><li><span class="section"><a href="#red_hat_quay_setup">2.5.1. Red Hat Quay setup</a></span></li><li><span class="section"><a href="#validate_and_download_configuration">2.5.2. Validate and download configuration</a></span></li></ul></li><li><span class="section"><a href="#deploying_red_hat_quay">2.6. Deploying Red Hat Quay</a></span><ul><li><span class="section"><a href="#prerequisites_2">2.6.1. Prerequisites</a></span></li><li><span class="section"><a href="#prepare_config_folder">2.6.2. Prepare config folder</a></span></li><li><span class="section"><a href="#prepare_local_storage_for_image_data">2.6.3. Prepare local storage for image data</a></span></li><li><span class="section"><a href="#deploy_the_red_hat_quay_registry">2.6.4. Deploy the Red Hat Quay registry</a></span></li></ul></li><li><span class="section"><a href="#using_red_hat_quay">2.7. Using Red Hat Quay</a></span><ul><li><span class="section"><a href="#push_and_pull_images">2.7.1. Push and pull images</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#advanced_red_hat_quay_deployment">3. Advanced Red Hat Quay deployment</a></span><ul><li><span class="section"><a href="#deploying_clair_v4">3.1. Deploying Clair V4</a></span><ul><li><span class="section"><a href="#deploying_a_separate_database_for_clair">3.1.1. Deploying a separate database for Clair</a></span></li><li><span class="section"><a href="#quay_configuration_for_clair">3.1.2. Quay configuration for Clair</a></span></li><li><span class="section"><a href="#clair_configuration">3.1.3. Clair configuration</a></span></li><li><span class="section"><a href="#running_clair">3.1.4. Running Clair</a></span></li><li><span class="section"><a href="#using_clair_security_scanning">3.1.5. Using Clair security scanning</a></span></li></ul></li><li><span class="section"><a href="#restarting_containers">3.2. Restarting containers</a></span><ul><li><span class="section"><a href="#using_systemd_unit_files_with_podman">3.2.1. Using systemd unit files with Podman</a></span></li><li><span class="section"><a href="#starting_stopping_and_checking_the_status_of_services">3.2.2. Starting, stopping and checking the status of services</a></span></li><li><span class="section"><a href="#testing_restart_after_reboot">3.2.3. Testing restart after reboot</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#next_steps">4. Next steps</a></span></li></ul></div><section class="preface" id="idm45346039465216"><div class="titlepage"><div><div><h1 class="title">Preface</h1></div></div></div><p>
			Red Hat Quay is an enterprise-quality registry for building, securing and serving container images. This procedure describes how to deploy Red Hat Quay for proof-of-concept (non-production) purposes.
		</p></section><section class="chapter" id="overview"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Overview</h1></div></div></div><p>
			Features of Red Hat Quay include:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					High availability
				</li><li class="listitem">
					Geo-replication
				</li><li class="listitem">
					Repository mirroring
				</li><li class="listitem">
					Docker v2, schema 2 (multiarch) support
				</li><li class="listitem">
					Continuous integration
				</li><li class="listitem">
					Security scanning with Clair
				</li><li class="listitem">
					Custom log rotation
				</li><li class="listitem">
					Zero downtime garbage collection
				</li><li class="listitem">
					24/7 support
				</li></ul></div><p>
			Red Hat Quay provides support for:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Multiple authentication and access methods
				</li><li class="listitem">
					Multiple storage backends
				</li><li class="listitem">
					Custom certificates for Quay, Clair, and storage backends
				</li><li class="listitem">
					Application registries
				</li><li class="listitem">
					Different container image types
				</li></ul></div><section class="section" id="architecture"><div class="titlepage"><div><div><h2 class="title">1.1. Architecture</h2></div></div></div><p>
				Red Hat Quay consists of a number of core components, both internal and external.
			</p><section class="section" id="internal_components"><div class="titlepage"><div><div><h3 class="title">1.1.1. Internal components</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Quay (container registry)</strong></span>: Runs the quay container as a service, consisting of several components in the pod.
						</li><li class="listitem">
							<span class="strong strong"><strong>Clair</strong></span>: Scans container images for vulnerabilities and suggests fixes.
						</li></ul></div></section><section class="section" id="external_components"><div class="titlepage"><div><div><h3 class="title">1.1.2. External components</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Database</strong></span>: Used by Red Hat Quay as its primary metadata storage (not for image storage).
						</li><li class="listitem">
							<span class="strong strong"><strong>Redis (key-value store)</strong></span>: Stores live builder logs and the Red Hat Quay tutorial.
						</li><li class="listitem"><p class="simpara">
							<span class="strong strong"><strong>Cloud storage</strong></span>:For supported deployments, you need to use one of the following types of storage:
						</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
									<span class="strong strong"><strong>Public cloud storage</strong></span>: In public cloud environments, you should use the cloud provider’s object storage, such as Amazon S3 (for AWS) or Google Cloud Storage (for Google Cloud).
								</li><li class="listitem">
									<span class="strong strong"><strong>Private cloud storage</strong></span>: In private clouds, an S3 or Swift compliant Object Store is needed, such as Ceph RADOS, or OpenStack Swift.
								</li></ul></div></li></ul></div><div class="admonition warning"><div class="admonition_header">Warning</div><div><p>
						Do not use "Locally mounted directory" Storage Engine for any production configurations. Mounted NFS volumes are not supported. Local storage is meant for Red Hat Quay test-only installations.
					</p></div></div></section></section></section><section class="chapter" id="getting_started_with_red_hat_quay"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Getting started with Red Hat Quay</h1></div></div></div><p>
			The Red Hat Quay registry can be deployed for non-production purposes on a single machine (either physical or virtual) with the following specifications.
		</p><section class="section" id="prerequisites"><div class="titlepage"><div><div><h2 class="title">2.1. Prerequisites</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						<span class="strong strong"><strong>Red Hat Enterprise Linux (RHEL)</strong></span>: Obtain the latest Red Hat Enterprise Linux 8 server media from the <a class="link" href="https://access.redhat.com/downloads/content/479/ver=/rhel---8/8.3/x86_64/product-software">Downloads page</a> and follow the installation instructions available in the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/">Product Documentation for Red Hat Enterprise Linux 8</a>.
					</li><li class="listitem">
						<span class="strong strong"><strong>Valid Red Hat Subscription</strong></span>: Configure a valid Red Hat Enterprise Linux 8 server subscription.
					</li><li class="listitem">
						<span class="strong strong"><strong>CPUs</strong></span>: Two or more virtual CPUs
					</li><li class="listitem">
						<span class="strong strong"><strong>RAM</strong></span>: 4GB or more
					</li><li class="listitem"><p class="simpara">
						<span class="strong strong"><strong>Disk space</strong></span>: The required disk space depends on the storage needs for the registry. Approximately 30GB of disk space should be enough for a test system, broken down as follows:
					</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
								At least 10GB of disk space for the operating system (Red Hat Enterprise Linux Server).
							</li><li class="listitem">
								At least 10GB of disk space for docker storage (to run 3 containers)
							</li><li class="listitem">
								At least 10GB of disk space for Quay local storage (CEPH or other local storage might require more memory)
							</li></ul></div></li></ul></div><p>
				More information on sizing can be found at <a class="link" href="https://access.redhat.com/articles/5177961">Quay 3.x Sizing Guidlines</a>.
			</p><section class="section" id="using_podman"><div class="titlepage"><div><div><h3 class="title">2.1.1. Using podman</h3></div></div></div><p>
					This document uses <code class="literal">podman</code> for creating and deploying containers. If you do not have <code class="literal">podman</code> installed on your system, you should be able to use the equivalent <code class="literal">docker</code> commands. For more information on podman and related technologies, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/building_running_and_managing_containers/index">Building, running, and managing Linux containers on Red Hat Enterprise Linux 8</a>.
				</p></section></section><section class="section" id="configuring_the_rhel_server"><div class="titlepage"><div><div><h2 class="title">2.2. Configuring the RHEL server</h2></div></div></div><section class="section" id="install_and_register_red_hat_enterprise_linux_server"><div class="titlepage"><div><div><h3 class="title">2.2.1. Install and register Red Hat Enterprise Linux server</h3></div></div></div><p>
					Install the latest RHEL 8 server. You can do a minimal install (shell access only) or Server plus GUI (if you want a desktop). Register and subscribe your RHEL server system as described in <a class="link" href="https://access.redhat.com/solutions/253273">How to register and subscribe a system…​</a>. The following commands register your system and list available subscriptions. Choose an available RHEL server subscription, attach to its pool ID and upgrade to the latest software:
				</p><p>
					+
				</p><pre class="literallayout"># subscription-manager register --username=&lt;user_name&gt; --password=&lt;password&gt;
# subscription-manager refresh
# subscription-manager list --available
# subscription-manager attach --pool=&lt;pool_id&gt;
# yum update -y</pre></section><section class="section" id="installing_podman"><div class="titlepage"><div><div><h3 class="title">2.2.2. Installing podman</h3></div></div></div><p>
					Install podman, if it is not already present on your system:
				</p><pre class="literallayout">$ sudo yum install -y podman</pre><p>
					Alternatively, you can install the <code class="literal">container-tools</code> module, which pulls in the full set of container software packages:
				</p><pre class="literallayout">$ sudo yum module install -y container-tools</pre></section><section class="section" id="registry_authentication"><div class="titlepage"><div><div><h3 class="title">2.2.3. Registry authentication</h3></div></div></div><p>
					Set up authentication to <code class="literal">registry.redhat.io</code>, so that you can pull the quay container, as described in <a class="link" href="https://access.redhat.com/RegistryAuthentication">Red Hat Container Registry Authentication</a>. Note that this differs from earlier Red Hat Quay releases where the images were hosted on quay.io.
				</p><p>
					For example, you can log in to the registry:
				</p><pre class="literallayout">$ sudo podman login registry.redhat.io
Username: &lt;username&gt;
Password: &lt;password&gt;</pre></section><section class="section" id="firewall_configuration"><div class="titlepage"><div><div><h3 class="title">2.2.4. Firewall configuration</h3></div></div></div><p>
					If you have a firewall running on your system, to access the Red Hat Quay config tool (port 8443) and application (ports 8080 and 443) outside of the local system, run the following commands (add <code class="literal">--zone=&lt;yourzone&gt;</code> for each command to open ports on a particular zone):
				</p><pre class="literallayout"># firewall-cmd --permanent --add-port=8443/tcp
# firewall-cmd --permanent --add-port=8080/tcp
# firewall-cmd --permanent --add-port=443/tcp
# firewall-cmd --reload</pre></section><section class="section" id="ip-naming"><div class="titlepage"><div><div><h3 class="title">2.2.5. IP addressing and naming services</h3></div></div></div><p>
					There are a number of ways to configure the component containers in Red Hat Quay so that they can talk to each other:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
							<span class="strong strong"><strong>Using the IP addresses for the containers:</strong></span> You can determine the IP address for containers with <code class="literal">podman inspect</code> and then use these values in the configuration tool when specifying the connection strings, for example:
						</p><pre class="literallayout">$ sudo podman inspect -f "{{.NetworkSettings.IPAddress}}" postgresql-quay</pre><p class="simpara">
							This approach is susceptible to host restarts, as the IP addresses for the containers will change after a reboot.
						</p></li><li class="listitem">
							<span class="strong strong"><strong>Using a naming service:</strong></span> If you want your deployment to survive container restarts, which typically result in changed IP addresses, you can implement a naming service. For example, the <a class="link" href="https://github.com/containers/dnsname">dnsname</a> plugin is used to allow containers to resolve each other by name.
						</li><li class="listitem">
							<span class="strong strong"><strong>Using the host network:</strong></span> You can use the <code class="literal">podman run</code> command with the <code class="literal">--net=host</code> option and then use container ports on the host when specifying the addresses in the configuration. This option is susceptible to port conflicts when two containers want to use the same port, and as a result it is not recommended.
						</li><li class="listitem">
							<span class="strong strong"><strong>Configuring port mapping:</strong></span> You can use port mappings to expose ports on the host and then use these ports in combination with the host IP address or host name.
						</li></ul></div><p>
					This document uses port mapping in the subsequent examples, and assumes a static IP address for your host system. In this example, <code class="literal">quay-server</code> has the IP address <code class="literal">192.168.1.112</code>.
				</p><pre class="literallayout">$ cat /etc/hosts
...
192.168.1.112   quay-server</pre><div class="informaltable"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 50%; " class="col_1"/><col style="width: 25%; " class="col_2"/><col style="width: 25%; " class="col_3"/></colgroup><thead><tr><th align="left" valign="top" id="idm45346039275696" scope="col">Component</th><th align="left" valign="top" id="idm45346039238880" scope="col">Port mapping</th><th align="left" valign="top" id="idm45346038659840" scope="col">Address</th></tr></thead><tbody><tr><td align="left" valign="top" headers="idm45346039275696">
								<p>
									Quay
								</p>
								</td><td align="left" valign="top" headers="idm45346039238880">
								<p>
									<code class="literal">-p 8080:8080</code>
								</p>
								</td><td align="left" valign="top" headers="idm45346038659840">
								<p>
									http://quay-server:8080
								</p>
								</td></tr><tr><td align="left" valign="top" headers="idm45346039275696">
								<p>
									Postgres for Quay
								</p>
								</td><td align="left" valign="top" headers="idm45346039238880">
								<p>
									<code class="literal">-p 5432:5432</code>
								</p>
								</td><td align="left" valign="top" headers="idm45346038659840">
								<p>
									quay-server:5432
								</p>
								</td></tr><tr><td align="left" valign="top" headers="idm45346039275696">
								<p>
									Redis
								</p>
								</td><td align="left" valign="top" headers="idm45346039238880">
								<p>
									<code class="literal">-p 6379:6379</code>
								</p>
								</td><td align="left" valign="top" headers="idm45346038659840">
								<p>
									quay-server:6379
								</p>
								</td></tr><tr><td align="left" valign="top" headers="idm45346039275696">
								<p>
									Postgres for Clair V4
								</p>
								</td><td align="left" valign="top" headers="idm45346039238880">
								<p>
									<code class="literal">-p 5433:5432</code>
								</p>
								</td><td align="left" valign="top" headers="idm45346038659840">
								<p>
									quay-server:5433
								</p>
								</td></tr><tr><td align="left" valign="top" headers="idm45346039275696">
								<p>
									Clair V4
								</p>
								</td><td align="left" valign="top" headers="idm45346039238880">
								<p>
									<code class="literal">-p 8081:8080</code>
								</p>
								</td><td align="left" valign="top" headers="idm45346038659840">
								<p>
									http://quay-server:8081
								</p>
								</td></tr></tbody></table></div></section></section><section class="section" id="configuring_the_database"><div class="titlepage"><div><div><h2 class="title">2.3. Configuring the database</h2></div></div></div><p>
				Quay requires a database for storing metadata and Postgres is recommended, especially for highly available configurations. Alternatively, you can use MySQL with a similar approach to configuration as described below for Postgres.
			</p><section class="section" id="setting_up_postgres"><div class="titlepage"><div><div><h3 class="title">2.3.1. Setting up Postgres</h3></div></div></div><p>
					In this proof-of-concept scenario, you will use a directory on the local file system to persist database data.
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
							In the installation folder, denoted here by the variable $QUAY, create a directory for the database data and set the permissions appropriately:
						</p><pre class="literallayout">$ mkdir -p $QUAY/postgres-quay
$ setfacl -m u:26:-wx $QUAY/postgres-quay</pre></li><li class="listitem"><p class="simpara">
							Use podman to run the Postgres container, specifying the username, password, database name and port, together with the volume definition for database data:
						</p><pre class="literallayout">$ sudo podman run -d --rm --name postgresql-quay \
  -e POSTGRESQL_USER=quayuser \
  -e POSTGRESQL_PASSWORD=quaypass \
  -e POSTGRESQL_DATABASE=quay \
  -e POSTGRESQL_ADMIN_PASSWORD=adminpass \
  -p 5432:5432 \
  -v $QUAY/postgres-quay:/var/lib/pgsql/data:Z \
  registry.redhat.io/rhel8/postgresql-10:1</pre></li><li class="listitem"><p class="simpara">
							Ensure that the Postgres <code class="literal">pg_trgm</code> module is installed, as it is required by Quay:
						</p><pre class="literallayout">$ sudo podman exec -it postgresql-quay /bin/bash -c 'echo "CREATE EXTENSION IF NOT EXISTS pg_trgm" | psql -d quay -U postgres'</pre></li></ul></div></section></section><section class="section" id="configuring_redis"><div class="titlepage"><div><div><h2 class="title">2.4. Configuring Redis</h2></div></div></div><p>
				Redis ia a key-value store, used by Quay for live builder logs and the Red Hat Quay tutorial.
			</p><section class="section" id="setting_up_redis"><div class="titlepage"><div><div><h3 class="title">2.4.1. Setting up Redis</h3></div></div></div><p>
					Use podman to run the Redis container, specifying the port and password:
				</p><pre class="literallayout">$ sudo podman run -d --rm --name redis \
  -p 6379:6379 \
  -e REDIS_PASSWORD=strongpassword \
  registry.redhat.io/rhel8/redis-5:1</pre></section></section><section class="section" id="configuring_red_hat_quay"><div class="titlepage"><div><div><h2 class="title">2.5. Configuring Red Hat Quay</h2></div></div></div><p>
				Before running the Red Hat Quay service, you need to generate a configuration file containing details of all the components, including registry settings, and database and Redis connection parameters. To generate the configuration file, you run the quay container in <code class="literal">config</code> mode, specifying a password (in this instance, <code class="literal">secret</code>) for the <code class="literal">quayconfig</code> user:
			</p><pre class="literallayout">$ sudo podman run --rm -it --name quay_config -p 8080:8080 registry.redhat.io/quay/quay-rhel8:v3.4.1 config secret</pre><p>
				Use your browser to access the user interface for the configuration tool at <code class="literal">http://quay-server:8080</code> (assuming you have configured the <code class="literal">quay-server</code> hostname in your <code class="literal">hosts</code> file). Login with the username <code class="literal">quayconfig</code> and password <code class="literal">secret</code> (or whatever value you specified in the podman run command above).
			</p><section class="section" id="red_hat_quay_setup"><div class="titlepage"><div><div><h3 class="title">2.5.1. Red Hat Quay setup</h3></div></div></div><p>
					In the configuration editor, you enter details for the following:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Basic configuration
						</li><li class="listitem">
							Server configuration
						</li><li class="listitem">
							Database
						</li><li class="listitem">
							Redis
						</li></ul></div><section class="section" id="basic_configuration"><div class="titlepage"><div><div><h4 class="title">2.5.1.1. Basic configuration</h4></div></div></div><p>
						In the basic configuration setting, complete the registry title and the registry short title fields (or you can use the default values, if they are specified).
					</p></section><section class="section" id="server_configuration"><div class="titlepage"><div><div><h4 class="title">2.5.1.2. Server configuration</h4></div></div></div><p>
						Specify the HTTP host and port, for the location where the registry will be accessible on the network, in this instance, <code class="literal">quay-server:8080</code>.
					</p></section><section class="section" id="database"><div class="titlepage"><div><div><h4 class="title">2.5.1.3. Database</h4></div></div></div><p>
						In the database section, specify connection details for the database that Red Hat Quay uses to store metadata. If you have followed the instructions in this document for deploying a proof-of-concept system, the following values would be entered:
					</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
								<span class="strong strong"><strong>Database Type:</strong></span> Postgres
							</li><li class="listitem">
								<span class="strong strong"><strong>Database Server:</strong></span> quay-server:5432
							</li><li class="listitem">
								<span class="strong strong"><strong>Username:</strong></span> quayuser
							</li><li class="listitem">
								<span class="strong strong"><strong>Password:</strong></span> quaypass
							</li><li class="listitem">
								<span class="strong strong"><strong>Database Name:</strong></span> quay
							</li></ul></div></section><section class="section" id="redis"><div class="titlepage"><div><div><h4 class="title">2.5.1.4. Redis</h4></div></div></div><p>
						The Redis key-value store is used to store real-time events and build logs. If you have followed the instructions in this document for deploying a proof-of-concept system, the following values would be specified:
					</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
								<span class="strong strong"><strong>Redis Hostname:</strong></span> quay-server
							</li><li class="listitem">
								<span class="strong strong"><strong>Redis port:</strong></span> 6379 (default)
							</li></ul></div></section></section><section class="section" id="validate_and_download_configuration"><div class="titlepage"><div><div><h3 class="title">2.5.2. Validate and download configuration</h3></div></div></div><p>
					When all required fields have been set, validate your settings by choosing the Validate Configuration Changes button. If any errors are reported, continue editing your configuration until all required fields are valid and Red Hat Quay can connect to your database and Redis servers.
				</p><p>
					Once your configuration is valid, download the configuration file and then stop the quay container that is running the configuration editor.
				</p></section></section><section class="section" id="deploying_red_hat_quay"><div class="titlepage"><div><div><h2 class="title">2.6. Deploying Red Hat Quay</h2></div></div></div><section class="section" id="prerequisites_2"><div class="titlepage"><div><div><h3 class="title">2.6.1. Prerequisites</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Your Quay database and Redis servers are running.
						</li><li class="listitem">
							You have generated a valid configuration bundle.
						</li><li class="listitem">
							You have stopped the Quay container that you used to run the configuration editor.
						</li></ul></div></section><section class="section" id="prepare_config_folder"><div class="titlepage"><div><div><h3 class="title">2.6.2. Prepare config folder</h3></div></div></div><p>
					Unpack the configuration bundle so that Quay can use it, for example:
				</p><pre class="literallayout">$ mkdir $QUAY/config
$ cp ~/Downloads/quay-config.tar.gz $QUAY/config
$ cd $QUAY/config
$ tar xvf quay-config.tar.gz</pre></section><section class="section" id="prepare_local_storage_for_image_data"><div class="titlepage"><div><div><h3 class="title">2.6.3. Prepare local storage for image data</h3></div></div></div><p>
					In this proof-of-concept deployment, use the local file system to store the registry images:
				</p><pre class="literallayout">$ mkdir $QUAY/storage
$ setfacl -m u:1001:-wx $QUAY/storage</pre></section><section class="section" id="deploy_the_red_hat_quay_registry"><div class="titlepage"><div><div><h3 class="title">2.6.4. Deploy the Red Hat Quay registry</h3></div></div></div><p>
					Use podman to run the quay container, specifying the appropriate volumes for your configuration data and local storage for image data:
				</p><pre class="literallayout">$ sudo podman run -d --rm -p 8080:8080  \
   --name=quay \
   -v $QUAY/config:/conf/stack:Z \
   -v $QUAY/storage:/datastorage:Z \
   registry.redhat.io/quay/quay-rhel8:v3.4.1</pre></section></section><section class="section" id="using_red_hat_quay"><div class="titlepage"><div><div><h2 class="title">2.7. Using Red Hat Quay</h2></div></div></div><p>
				Use your browser to access the user interface for the Red Hat Quay registry at <code class="literal">quay-server:8080</code> (assuming you have configured the <code class="literal">quay-server</code> hostname in your <code class="literal">hosts</code> file). Select 'Create User' and add a user, for example, <code class="literal">quayadmin</code> with a password <code class="literal">password</code>.
			</p><p>
				You can now use the user interface to create new organizations and repositories, and to search and browse existing repositories. Alternatively, you can use the command line interface to interact with the registry and to pull and push images.
			</p><p>
				From the command line, log in to the registry:
			</p><pre class="literallayout">$ sudo podman login --tls-verify=false quay-server:8080
Username: quayadmin
Password:
Login Succeeded!</pre><section class="section" id="push_and_pull_images"><div class="titlepage"><div><div><h3 class="title">2.7.1. Push and pull images</h3></div></div></div><p>
					To test pushing and pulling images from the Red Hat Quay registry, first pull a sample image from an external registry:
				</p><pre class="literallayout">$ sudo podman pull busybox
Trying to pull docker.io/library/busybox...
Getting image source signatures
Copying blob 4c892f00285e done
Copying config 22667f5368 done
Writing manifest to image destination
Storing signatures
22667f53682a2920948d19c7133ab1c9c3f745805c14125859d20cede07f11f9</pre><p>
					Use the <code class="literal">podman images</code> command to see the local copy:
				</p><pre class="literallayout">$ sudo podman images
REPOSITORY                          TAG      IMAGE ID       CREATED         SIZE
docker.io/library/busybox           latest   22667f53682a   14 hours ago    1.45 MB
...</pre><p>
					Tag this image, in preparation for pushing it to the Red Hat Quay registry:
				</p><pre class="literallayout">$ sudo podman tag docker.io/library/busybox quay-server:8080/quayadmin/busybox:test</pre><p>
					Now push the image to the Red Hat Quay registry:
				</p><pre class="literallayout">$ sudo podman push --tls-verify=false quay-server:8080/quayadmin/busybox:test
Getting image source signatures
Copying blob 6b245f040973 done
Copying config 22667f5368 done
Writing manifest to image destination
Storing signatures</pre><p>
					At this point, you can use your browser to see the tagged image in your repository. To test access to the image from the command line, first delete the local copy of the image:
				</p><pre class="literallayout">$ sudo podman rmi quay-server:8080/quayadmin/busybox:test
Untagged: quay-server:8080/quayadmin/busybox:test</pre><p>
					Now pull the image again, this time from your Red Hat Quay registry:
				</p><pre class="literallayout">$ sudo podman pull --tls-verify=false quay-server:8080/quayadmin/busybox:test
Trying to pull quay-server:8080/quayadmin/busybox:test...
Getting image source signatures
Copying blob 6ef22a7134ba [--------------------------------------] 0.0b / 0.0b
Copying config 22667f5368 done
Writing manifest to image destination
Storing signatures
22667f53682a2920948d19c7133ab1c9c3f745805c14125859d20cede07f11f9</pre></section></section></section><section class="chapter" id="advanced_red_hat_quay_deployment"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Advanced Red Hat Quay deployment</h1></div></div></div><section class="section" id="deploying_clair_v4"><div class="titlepage"><div><div><h2 class="title">3.1. Deploying Clair V4</h2></div></div></div><section class="section" id="deploying_a_separate_database_for_clair"><div class="titlepage"><div><div><h3 class="title">3.1.1. Deploying a separate database for Clair</h3></div></div></div><p>
					Clair requires a database and Postgres is recommended, especially for highly available configurations. You can share a common database between Quay and Clair, but in this example a separate, Clair-specific database is deployed.
				</p><p>
					In this proof-of-concept scenario, you will use a directory on the local file system to persist database data.
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
							In the installation folder, denoted here by the variable $QUAY, create a directory for the Clair database data and set the permissions appropriately:
						</p><pre class="literallayout">$ mkdir -p $QUAY/postgres-clairv4
$ setfacl -m u:26:-wx $QUAY/postgres-clairv4</pre></li><li class="listitem"><p class="simpara">
							Use podman to run the Postgres container, specifying the username, password, database name and port, together with the volume definition for database data. As the standard Postgres port, <code class="literal">5432</code>, is already in use by the Quay deployment, expose a different port, in this instance <code class="literal">5433</code>:
						</p><pre class="literallayout">$ sudo podman run -d --rm --name postgresql-clairv4 \
  -e POSTGRESQL_USER=clairuser \
  -e POSTGRESQL_PASSWORD=clairpass \
  -e POSTGRESQL_DATABASE=clair \
  -e POSTGRESQL_ADMIN_PASSWORD=adminpass \
  -p 5433:5432 \
  -v $QUAY/postgres-clairv4:/var/lib/pgsql/data:Z \
  registry.redhat.io/rhel8/postgresql-10:1</pre></li><li class="listitem"><p class="simpara">
							Ensure that the Postgres <code class="literal">uuid-ossp</code> module is installed, as it is required by Clair:
						</p><pre class="literallayout">$ sudo podman exec -it postgresql-quay /bin/bash -c 'echo "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"" | psql -d clair -U postgres'</pre></li></ul></div></section><section class="section" id="quay_configuration_for_clair"><div class="titlepage"><div><div><h3 class="title">3.1.2. Quay configuration for Clair</h3></div></div></div><p>
					Stop the Quay container if it is running, and restart it in configuration mode, loading the existing configuration as a volume:
				</p><pre class="literallayout">$ sudo podman run --rm -it --name quay_config \
  -p 8080:8080 \
  -v $QUAY/config:/conf/stack:Z \
  registry.redhat.io/quay/quay-rhel8:v3.4.1 config secret</pre><p>
					Log in to the configuration tool and enable scanning, in the Security Scanner section of the UI. Set the HTTP endpoint for Clair, using a port that is not already in use on the <code class="literal">quay-server</code> system, for example <code class="literal">8081</code>. Create a Clair pre-shared key (PSK) using the <code class="literal">Generate PSK</code> button, for example:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<span class="strong strong"><strong>Security Scanner Endpoint:</strong></span> <code class="literal">http://quay-server:8081</code>
						</li><li class="listitem">
							<span class="strong strong"><strong>Security Scanner PSK:</strong></span> <code class="literal">MTU5YzA4Y2ZkNzJoMQ==</code>
						</li></ul></div><p>
					The UI for setting the scanner data is shown in the following image:
				</p><div class="formalpara"><p class="title"><strong>Security Scanner UI</strong></p><p>
						<span class="inlinemediaobject"><img src="images/poc-quay-scanner-config.png" alt="Security Scanner"/></span>
					</p></div><p>
					Validate and download the configuration and then stop the Quay container that is running the configuration editor. Extract the configuration bundle as before into the <code class="literal">$QUAY/config</code> directory.
				</p><pre class="literallayout">$ cp ~/Downloads/quay-config.tar.gz $QUAY/config
$ cd $QUAY/config
$ tar xvf quay-config.tar.gz</pre><p>
					The Quay configuration file has been updated to contain the fields for the security scanner:
				</p><div class="formalpara"><p class="title"><strong>$QUAY/config/config.yaml</strong></p><p>
						
<pre class="programlisting language-yaml">FEATURE_SECURITY_NOTIFICATIONS: false
FEATURE_SECURITY_SCANNER: true
...
SECURITY_SCANNER_INDEXING_INTERVAL: 30
SECURITY_SCANNER_V4_ENDPOINT: http://quay-server:8081
SECURITY_SCANNER_V4_PSK: MTU5YzA4Y2ZkNzJoMQ==
SERVER_HOSTNAME: quay-server:8080</pre>
					</p></div></section><section class="section" id="clair_configuration"><div class="titlepage"><div><div><h3 class="title">3.1.3. Clair configuration</h3></div></div></div><p>
					Detailed information on Clair configuration is available at <a class="link" href="https://github.com/quay/clair/blob/main/Documentation/reference/config.md">https://github.com/quay/clair/blob/main/Documentation/reference/config.md</a>. The following example provides a minimal configuration for use in a proof of concept deployment:
				</p><div class="formalpara"><p class="title"><strong>/etc/clairv4/config/config.yaml</strong></p><p>
						
<pre class="programlisting language-yaml">http_listen_addr: :8081
introspection_addr: :8089
log_level: debug
indexer:
  connstring: host=quay-server port=5433 dbname=clair user=clairuser password=clairpass sslmode=disable
  scanlock_retry: 10
  layer_scan_concurrency: 5
  migrations: true
matcher:
  connstring: host=quay-server port=5433 dbname=clair user=clairuser password=clairpass sslmode=disable
  max_conn_pool: 100
  run: ""
  migrations: true
  indexer_addr: clair-indexer
notifier:
  connstring: host=quay-server port=5433 dbname=clair user=clairuser password=clairpass sslmode=disable
  delivery_interval: 1m
  poll_interval: 5m
  migrations: true
auth:
  psk:
    key: "MTU5YzA4Y2ZkNzJoMQ=="
    iss: ["quay"]
# tracing and metrics
trace:
  name: "jaeger"
  probability: 1
  jaeger:
    agent_endpoint: "localhost:6831"
    service_name: "clair"
metrics:
  name: "prometheus"</pre>
					</p></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							<code class="literal">http_listen_addr</code> is set to the port of the Clair HTTP endpoint that you specified in the Quay configuration tool, in this case <code class="literal">:8081</code>.
						</li><li class="listitem">
							The Clair pre-shared key (PSK) that you generated in the Quay configuration tool is used for authentication, with the issuer, specified in the <code class="literal">iss</code> field, set to <code class="literal">quay</code>.
						</li></ul></div></section><section class="section" id="running_clair"><div class="titlepage"><div><div><h3 class="title">3.1.4. Running Clair</h3></div></div></div><p>
					Use the <code class="literal">podman run</code> command to run the Clair container, exposing the HTTP endpoint port that you specified in the configuration tool, in this case <code class="literal">8081</code>:
				</p><pre class="literallayout">sudo podman run -d --rm --name clairv4 \
  -p 8081:8081 -p 8089:8089 \
  -e CLAIR_CONF=/clair/config.yaml -e CLAIR_MODE=combo \
  -v /etc/clairv4/config:/clair:Z \
  registry.redhat.io/quay/clair-rhel8:v3.4.1</pre><p>
					Now restart the Quay container, using the updated configuration file containing the scanner settings:
				</p><pre class="literallayout">$ sudo podman run -d --rm -p 8080:8080  \
   --name=quay \
   -v $QUAY/config:/conf/stack:Z \
   -v $QUAY/storage:/datastorage:Z \
   registry.redhat.io/quay/quay-rhel8:v3.4.1</pre></section><section class="section" id="using_clair_security_scanning"><div class="titlepage"><div><div><h3 class="title">3.1.5. Using Clair security scanning</h3></div></div></div><p>
					From the command line, log in to the registry:
				</p><pre class="literallayout">$ sudo podman login --tls-verify=false quay-server:8080
Username: quayadmin
Password:
Login Succeeded!</pre><p>
					Pull, tag and push a sample image to the registry:
				</p><pre class="literallayout">$ sudo podman pull ubuntu:20.04
$ sudo podman tag docker.io/library/ubuntu:20.04 quay-server:8080/quayadmin/ubuntu:20.04
$ sudo podman push --tls-verify=false quay-server:8080/quayadmin/ubuntu:20.04</pre><p>
					The results from the security scanning can be seen in the Quay UI, as shown in the following images:
				</p><div class="formalpara"><p class="title"><strong>Scanning summary</strong></p><p>
						<span class="inlinemediaobject"><img src="images/poc-clair-1.png" alt="Scanning summary"/></span>
					</p></div><div class="formalpara"><p class="title"><strong>Scanning details</strong></p><p>
						<span class="inlinemediaobject"><img src="images/poc-clair-2.png" alt="Scanning details"/></span>
					</p></div></section></section><section class="section" id="restarting_containers"><div class="titlepage"><div><div><h2 class="title">3.2. Restarting containers</h2></div></div></div><p>
				Because the <code class="literal">--restart</code> option is not fully supported by podman, you can configure <code class="literal">podman</code> as a systemd service, as described in <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/building_running_and_managing_containers/index#porting-containers-to-systemd-using-podman_building-running-and-managing-containers">Porting containers to systemd using Podman</a>
			</p><section class="section" id="using_systemd_unit_files_with_podman"><div class="titlepage"><div><div><h3 class="title">3.2.1. Using systemd unit files with Podman</h3></div></div></div><p>
					By default, Podman generates a unit file for existing containers or pods. You can generate more portable systemd unit files using the <code class="literal">podman generate systemd --new</code> command. The <code class="literal">--new</code> flag instructs Podman to generate unit files that create, start and remove containers.
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
							Create the systemd unit files from a running Red Hat Quay registry as follows:
						</p><pre class="literallayout">$ sudo podman generate systemd --new --files --name postgresql-quay
$ sudo podman generate systemd --new --files --name redis
$ sudo podman generate systemd --new --files --name quay</pre></li><li class="listitem"><p class="simpara">
							Copy the unit files to <code class="literal">/usr/lib/systemd/system</code> for installing them as a root user:
						</p><pre class="literallayout">$ sudo cp -Z container-redis.service /usr/lib/systemd/system
$ sudo cp -Z container-postgresql-quay.service /usr/lib/systemd/system
$ sudo cp -Z container-quay.service /usr/lib/systemd/system</pre></li><li class="listitem"><p class="simpara">
							Reload systemd manager configuration:
						</p><pre class="literallayout">$ sudo systemctl daemon-reload</pre></li><li class="listitem"><p class="simpara">
							Enable the services and start them at boot time:
						</p><pre class="literallayout">$ sudo systemctl enable --now container-redis.service
$ sudo systemctl enable --now container-postgresql-quay.service
$ sudo systemctl enable --now container-quay.service</pre></li></ul></div></section><section class="section" id="starting_stopping_and_checking_the_status_of_services"><div class="titlepage"><div><div><h3 class="title">3.2.2. Starting, stopping and checking the status of services</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
							Check the status of the Quay components:
						</p><pre class="literallayout">$ sudo systemctl status container-redis.service
$ sudo systemctl status container-postgresql-quay.service
$ sudo systemctl status container-quay.service</pre></li><li class="listitem"><p class="simpara">
							To stop the Quay component services:
						</p><pre class="literallayout">$ sudo systemctl stop container-redis.service
$ sudo systemctl stop container-postgresql-quay.service
$ sudo systemctl stop container-quay.service</pre></li><li class="listitem"><p class="simpara">
							To start the Quay component services:
						</p><pre class="literallayout">$ sudo systemctl start container-redis.service
$ sudo systemctl start container-postgresql-quay.service
$ sudo systemctl start container-quay.service</pre></li></ul></div></section><section class="section" id="testing_restart_after_reboot"><div class="titlepage"><div><div><h3 class="title">3.2.3. Testing restart after reboot</h3></div></div></div><p>
					Once you have the services configured and enabled, reboot the system. When the system has re-started, use <code class="literal">podman ps</code> to check that all the containers for the Quay components have been restarted:
				</p><pre class="literallayout">$ sudo podman ps -a
CONTAINER ID  IMAGE                                      COMMAND               CREATED         STATUS             PORTS                   NAMES
215ea92f75be  registry.redhat.io/quay/quay-rhel8:v3.4.0  registry              36 seconds ago  Up 35 seconds ago  0.0.0.0:8080-&gt;8080/tcp  quay
82fd8191ef50  docker.io/library/postgres:10.12           postgres              36 seconds ago  Up 35 seconds ago  0.0.0.0:5432-&gt;5432/tcp  postgresql-quay
bca9a7ea090b  docker.io/library/redis:5.0.7              --requirepass str...  36 seconds ago  Up 36 seconds ago  0.0.0.0:6379-&gt;6379/tcp  redis</pre><p>
					Log in to the Red Hat Quay registry at <code class="literal">quay-server:8080</code> to check that everything has restarted correctly.
				</p></section></section></section><section class="chapter" id="next_steps"><div class="titlepage"><div><div><h1 class="title">Chapter 4. Next steps</h1></div></div></div><p>
			This document shows how to configure and deploy a proof-of-concept version of Red Hat Quay. For more information on deploying to a production environment, see the guide "Deploy Red Hat Quay - High Availability".
		</p><p>
			The "Use Red Hat Quay" guide shows you how to:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Add users and repositories
				</li><li class="listitem">
					Use tags
				</li><li class="listitem">
					Automatically build Dockerfiles with build workers
				</li><li class="listitem">
					Set up build triggers
				</li><li class="listitem">
					Add notifications for repository events
				</li></ul></div><p>
			The "Manage Red Hat Quay" guide shows you how to:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Use SSL and TLS
				</li><li class="listitem">
					Enable security scanning with Clair
				</li><li class="listitem">
					Use repository mirroring
				</li><li class="listitem">
					Configure LDAP authentication
				</li><li class="listitem">
					Use georeplication of storage
				</li></ul></div></section><div><div xml:lang="en-US" class="legalnotice" id="idm45346019194624"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"/>© 2021 Red Hat, Inc.
	</div><div class="para">
		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="uri" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
	</div><div class="para">
		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Linux</span>® is the registered trademark of Linus Torvalds in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Java</span>® is a registered trademark of Oracle and/or its affiliates.
	</div><div class="para">
		<span class="trademark">XFS</span>® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.
	</div><div class="para">
		<span class="trademark">MySQL</span>® is a registered trademark of MySQL AB in the United States, the European Union and other countries.
	</div><div class="para">
		<span class="trademark">Node.js</span>® is an official trademark of Joyent. Red Hat is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.
	</div><div class="para">
		The <span class="trademark">OpenStack</span>® Word Mark and OpenStack logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.
	</div><div class="para">
		All other trademarks are the property of their respective owners.
	</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>
<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Configure Red Hat Quay</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.4"/><meta name="description" content="Configure Red Hat Quay"/><link rel="next" href="#getting_started_with_configuration" title="Chapter 1. Getting started with configuration"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm44927251020976"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Quay</span> <span class="productnumber">3.5</span></div><div><h1 class="title">Configure Red Hat Quay</h1></div><div><h2 class="subtitle">Customizing Red Hat Quay using configuration options</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat OpenShift Documentation Team</span></div></div><div><a href="#idm44927234257392">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				Configure Red Hat Quay
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="chapter"><a href="#getting_started_with_configuration">1. Getting started with configuration</a></span></li><li><span class="chapter"><a href="#editing_the_configuration_file">2. Editing the configuration file</a></span><ul><li><span class="section"><a href="#location_of_configuration_file_in_a_standalone_deployment">2.1. Location of configuration file in a standalone deployment</a></span></li><li><span class="section"><a href="#configuring_ssl_using_the_command_line">2.2. Configuring SSL using the command line</a></span></li></ul></li><li><span class="chapter"><a href="#using_the_configuration_api">3. Using the configuration API</a></span><ul><li><span class="section"><a href="#retrieving_the_default_configuration">3.1. Retrieving the default configuration</a></span></li><li><span class="section"><a href="#retrieving_the_current_configuration">3.2. Retrieving the current configuration</a></span></li><li><span class="section"><a href="#validating_configuration_using_the_api">3.3. Validating configuration using the API</a></span></li><li><span class="section"><a href="#determining_the_required_fields">3.4. Determining the required fields</a></span></li></ul></li><li><span class="chapter"><a href="#using_the_configuration_tool">4. Using the configuration tool</a></span><ul><li><span class="section"><a href="#configuring_ssl_using_the_ui">4.1. Configuring SSL using the UI</a></span></li></ul></li></ul></div><section class="chapter" id="getting_started_with_configuration"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Getting started with configuration</h1></div></div></div><p>
			Red Hat Quay can be deployed in a standalone manner, or on an existing OpenShift cluster using the Operator. The methods you use to create, retrieve, update and validate the Red Hat Quay configuration vary slightly, depending on the type of deployment you are using. However, the core configuration options are fundamentally the same for all types of deployment, and these options can be manipulated:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					Directly, by editing the <code class="literal">config.yaml</code> file. See the section <a class="link" href="#editing_the_configuration_file" title="Chapter 2. Editing the configuration file">Editing the configuration file</a>.
				</li><li class="listitem">
					Programmatically, using the configuration API. See the section <a class="link" href="#using_the_configuration_api" title="Chapter 3. Using the configuration API">Using the configuration API</a>.
				</li><li class="listitem">
					Visually, using the configuration tool UI. See the section <a class="link" href="#using_the_configuration_tool" title="Chapter 4. Using the configuration tool">Using the configuration tool</a>.
				</li></ul></div><p>
			You can install Quay on OpenShift using the Operator, without the need to supply any initial configuration, as the Operator will supply sensible defaults to deploy the registry. For a standalone deployment, however, you must supply a minimal level of configuration before the registry can be started. The minimal requirements can be determined using the <a class="link" href="#retrieving_the_current_configuration" title="3.2. Retrieving the current configuration">configuration API</a> and are documented in the section
		</p><p>
			Once you have Quay deployed with your initial configuration, you should retrieve and save the full configuration from the running system as it may contain extra, generated values that you will need in future when restarting or upgrading your system.
		</p></section><section class="chapter" id="editing_the_configuration_file"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Editing the configuration file</h1></div></div></div><p>
			Deploying the registry in standalone mode requires a minimal configuration - see section …​
		</p><p>
			The configuration file is validated on startup of the registry, and any issue will be highlighted in the output:
		</p><p>
			It is possible to use the configuration API to validate the configuration, but this requires starting the Quay container in config mode
		</p><p>
			For changes to take effect, the registry needs to be restarted.
		</p><section class="section" id="location_of_configuration_file_in_a_standalone_deployment"><div class="titlepage"><div><div><h2 class="title">2.1. Location of configuration file in a standalone deployment</h2></div></div></div><p>
				For a standalone deployment, the <code class="literal">config.yaml</code> file must be supplied when starting the Quay registry. This file is located in the config volume, so in the following example, the config file is located at <code class="literal">$QUAY/config/config.yaml</code>:
			</p><pre class="literallayout">$ sudo podman run -d --rm -p 80:8080 -p 443:8443 \
   --name=quay \
   -v $QUAY/config:/conf/stack:Z \
   -v $QUAY/storage:/datastorage:Z \
   registry.redhat.io/quay/quay-rhel8:v3.5.1</pre></section><section class="section" id="configuring_ssl_using_the_command_line"><div class="titlepage"><div><div><h2 class="title">2.2. Configuring SSL using the command line</h2></div></div></div><p>
				Use the following steps to set up Quay to handle TLS:
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
						Copy the certificate file and primary key file to the configuration directory, ensuring they are named <code class="literal">ssl.cert</code> and <code class="literal">ssl.key</code> respectively.
					</li><li class="listitem"><p class="simpara">
						Edit the <code class="literal">config.yaml</code> file and specify that you want Quay to handle TLS:
					</p><div class="formalpara"><p class="title"><strong>config.yaml</strong></p><p>
							
<pre class="programlisting language-yaml">...
SERVER_HOSTNAME: quay-server.example.com
...
PREFERRED_URL_SCHEME: https
...</pre>
						</p></div></li><li class="listitem">
						Restart the registry for the configuration changes to take effect
					</li></ol></div></section></section><section class="chapter" id="using_the_configuration_api"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Using the configuration API</h1></div></div></div><p>
			The configuration tool exposes 4 endpoints that can be used to build, validate, bundle and deploy a configuration. The config-tool API is documented at <a class="link" href="https://github.com/quay/config-tool/blob/master/pkg/lib/editor/API.md">https://github.com/quay/config-tool/blob/master/pkg/lib/editor/API.md</a>. In this section, you will see how to use the API to retrieve the current configuration and how to validate any changes you make.
		</p><section class="section" id="retrieving_the_default_configuration"><div class="titlepage"><div><div><h2 class="title">3.1. Retrieving the default configuration</h2></div></div></div><p>
				If you are running the configuration tool for the first time, and do not have an existing configuration, you can retrieve the default configuration. Start the container in config mode:
			</p><pre class="literallayout">$ sudo podman run --rm -it --name quay_config \
  -p 8080:8080 \
  registry.redhat.io/quay/quay-rhel8:v3.5.1 config secret</pre><p>
				Use the <code class="literal">config</code> endpoint of the configuration API to get the default:
			</p><pre class="literallayout">$ curl -X GET -u quayconfig:secret http://quay-server:8080/api/v1/config  | jq</pre><p>
				The value returned is the default configuration in JSON format:
			</p><pre class="programlisting language-json">{
  "config.yaml": {
    "AUTHENTICATION_TYPE": "Database",
    "AVATAR_KIND": "local",
    "DB_CONNECTION_ARGS": {
      "autorollback": true,
      "threadlocals": true
    },
    "DEFAULT_TAG_EXPIRATION": "2w",
    "EXTERNAL_TLS_TERMINATION": false,
    "FEATURE_ACTION_LOG_ROTATION": false,
    "FEATURE_ANONYMOUS_ACCESS": true,
    "FEATURE_APP_SPECIFIC_TOKENS": true,
    ....
  }

}</pre></section><section class="section" id="retrieving_the_current_configuration"><div class="titlepage"><div><div><h2 class="title">3.2. Retrieving the current configuration</h2></div></div></div><p>
				If you have already configured and deployed the Quay registry, stop the container and restart it in configuration mode, loading the existing configuration as a volume:
			</p><pre class="literallayout">$ sudo podman run --rm -it --name quay_config \
  -p 8080:8080 \
  -v $QUAY/config:/conf/stack:Z \
  registry.redhat.io/quay/quay-rhel8:v3.5.1 config secret</pre><p>
				Use the <code class="literal">config</code> endpoint of the API to get the current configuration:
			</p><pre class="literallayout">$ curl -X GET -u quayconfig:secret http://quay-server:8080/api/v1/config  | jq</pre><p>
				The value returned is the current configuration in JSON format, including database and Redis configuration data:
			</p><pre class="programlisting language-json">{
  "config.yaml": {
    ....
    "BROWSER_API_CALLS_XHR_ONLY": false,
    "BUILDLOGS_REDIS": {
      "host": "quay-server",
      "password": "strongpassword",
      "port": 6379
    },
    "DATABASE_SECRET_KEY": "4b1c5663-88c6-47ac-b4a8-bb594660f08b",
    "DB_CONNECTION_ARGS": {
      "autorollback": true,
      "threadlocals": true
    },
    "DB_URI": "postgresql://quayuser:quaypass@quay-server:5432/quay",
    "DEFAULT_TAG_EXPIRATION": "2w",
    ....


  }

}</pre></section><section class="section" id="validating_configuration_using_the_api"><div class="titlepage"><div><div><h2 class="title">3.3. Validating configuration using the API</h2></div></div></div><p>
				You can validate a configuration by posting it to the <code class="literal">config/validate</code> endpoint:
			</p><pre class="literallayout">curl -u quayconfig:secret --header 'Content-Type: application/json' --request POST --data '
{
  "config.yaml": {
    ....
    "BROWSER_API_CALLS_XHR_ONLY": false,
    "BUILDLOGS_REDIS": {
      "host": "quay-server",
      "password": "strongpassword",
      "port": 6379
    },
    "DATABASE_SECRET_KEY": "4b1c5663-88c6-47ac-b4a8-bb594660f08b",
    "DB_CONNECTION_ARGS": {
      "autorollback": true,
      "threadlocals": true
    },
    "DB_URI": "postgresql://quayuser:quaypass@quay-server:5432/quay",
    "DEFAULT_TAG_EXPIRATION": "2w",
    ....

  }

} http://quay-server:8080/api/v1/config/validate | jq</pre><p>
				The returned value is an array containing the errors found in the configuration. If the configuration is valid, an empty array <code class="literal">[]</code> is returned.
			</p></section><section class="section" id="determining_the_required_fields"><div class="titlepage"><div><div><h2 class="title">3.4. Determining the required fields</h2></div></div></div><p>
				You can determine the required fields by posting an empty configuration structure to the <code class="literal">config/validate</code> endpoint:
			</p><pre class="literallayout">curl -u quayconfig:secret --header 'Content-Type: application/json' --request POST --data '
{
  "config.yaml": {
  }

} http://quay-server:8080/api/v1/config/validate | jq</pre><p>
				The value returned is an array indicating which fields are required:
			</p><pre class="screen">[
  {
    "FieldGroup": "Database",
    "Tags": [
      "DB_URI"
    ],
    "Message": "DB_URI is required."
  },
  {
    "FieldGroup": "DistributedStorage",
    "Tags": [
      "DISTRIBUTED_STORAGE_CONFIG"
    ],
    "Message": "DISTRIBUTED_STORAGE_CONFIG must contain at least one storage location."
  },
  {
    "FieldGroup": "HostSettings",
    "Tags": [
      "SERVER_HOSTNAME"
    ],
    "Message": "SERVER_HOSTNAME is required"
  },
  {
    "FieldGroup": "HostSettings",
    "Tags": [
      "SERVER_HOSTNAME"
    ],
    "Message": "SERVER_HOSTNAME must be of type Hostname"
  },
  {
    "FieldGroup": "Redis",
    "Tags": [
      "BUILDLOGS_REDIS"
    ],
    "Message": "BUILDLOGS_REDIS is required"
  }
]</pre></section></section><section class="chapter" id="using_the_configuration_tool"><div class="titlepage"><div><div><h1 class="title">Chapter 4. Using the configuration tool</h1></div></div></div><section class="section" id="configuring_ssl_using_the_ui"><div class="titlepage"><div><div><h2 class="title">4.1. Configuring SSL using the UI</h2></div></div></div><p>
				Start the Quay container in configuration mode and in the Server Configuration section, specify that you want Quay to handle TLS:
			</p><p>
				<span class="inlinemediaobject"><img src="images/ssl-config.png" alt="Enable SSL"/></span>
			</p><p>
				Upload the certificate file and private key file created earlier, ensuring that the Server Hostname matches the value used when creating the certs. Validate and download the updated configuration and then restart the registry.
			</p></section></section><div><div xml:lang="en-US" class="legalnotice" id="idm44927234257392"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"/>© 2021 Red Hat, Inc.
	</div><div class="para">
		The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="uri" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
	</div><div class="para">
		Red Hat, Red Hat Enterprise Linux, the Shadowman logo, the Red Hat logo, JBoss, OpenShift, Fedora, the Infinity logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Linux</span>® is the registered trademark of Linus Torvalds in the United States and other countries.
	</div><div class="para">
		<span class="trademark">Java</span>® is a registered trademark of Oracle and/or its affiliates.
	</div><div class="para">
		<span class="trademark">XFS</span>® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.
	</div><div class="para">
		<span class="trademark">MySQL</span>® is a registered trademark of MySQL AB in the United States, the European Union and other countries.
	</div><div class="para">
		<span class="trademark">Node.js</span>® is an official trademark of Joyent. Red Hat is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.
	</div><div class="para">
		The <span class="trademark">OpenStack</span>® Word Mark and OpenStack logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.
	</div><div class="para">
		All other trademarks are the property of their respective owners.
	</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>